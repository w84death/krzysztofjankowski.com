<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="favicon.png" type="image/png" />
    <link rel="stylesheet" href="style.css" />
    <title>How To Build 32-bit FLOPPINUX on a 64-bit Operating System</title>
  </head>
  <body>
    <main>
      <header>
        <h1>How To Build 32-bit FLOPPINUX on a 64-bit Operating System</h1>
        <span>Jun 6, 2021</span>
        <nav><a href="/floppinux/">back to home</a></nav>
      </header>

      <p>
        Thanks to the help of
        <a href="https://pappp.net/">pappp</a>
        I now have the updated instruction for 64-bit operating systems. It is
        little bit more complicated and I still recommend using VM or some old
        hardware.
      </p>
      <p>
        <a href="floppinux-an-embedded-linux-on-a-single-floppy.html"
          >Follow my 32-bit tutorial</a
        >
        and just make changes listed below. For ease let's make variable with
        the root of you workspace and processor cores:
      </p>
      <pre><code>BASE=~/my-linux-distro/
      CORES=12</code></pre>
      <h2 id="kernel">Kernel</h2>
      <p>Add <em>ARCH=x86</em> to each command, like so:</p>
      <pre><code>make ARCH=x86 tinyconfig
      make ARCH=x86 menuconfig</code></pre>
      <p>
        Additional setting. You only need xz support, uncheck all else than
        this:
      </p>
      <blockquote>
        General setup -&gt; Initial RAM filesystem and RAM disk
        (initramfs/initrd) support -&gt; select "<strong
          >Support initial ramdisk/ramfs compressed using xz"</strong
        >
      </blockquote>
      <pre><code>make ARCH=x86 bzImage -j ${CORES}</code></pre>
      <p>Build kernel:</p>
      <h3 id="check">Check</h3>
      <p>To be sure that you got 32-bit kernel use <em>file </em>command:</p>
      <pre><code>$ file bzImage
      bzImage: Linux kernel x86 boot executable bzImage, version 5.13.0-rc3+ (kj@dell-g5) #1 Sun May 30 11:03:50 CEST 2021, RO-rootFS, Normal VGA</code></pre>
      <h2 id="musl">Musl</h2>
      <p>Download and extract musl:</p>
      <pre><code>cd $BASE
      wget https://musl.cc/i486-linux-musl-cross.tgz
      tar xvf i486-linux-musl-cross.tgz</code></pre>
      <h2 id="busybox">BusyBox</h2>
      <p>BusyBox needs additional configuration to use musl.</p>
      <pre><code>cd $BASE/busybox
      make ARCH=x86 allnoconfig
      make ARCH=x86 menuconfig</code></pre>
      <p>
        Check same things as in 32-bit build. I added few extra things like
        <strong>help</strong> and <strong>alias</strong>.
      </p>
      <p>Then after saving update those four paths:</p>
      <!--kg-card-begin: markdown-->
      <pre><code>sed -i &quot;s|.*CONFIG_CROSS_COMPILER_PREFIX.*|CONFIG_CROSS_COMPILER_PREFIX=&quot;\&quot;${BASE}&quot;i486-linux-musl-cross/bin/i486-linux-musl-\&quot;|&quot; .config
      sed -i &quot;s|.*CONFIG_SYSROOT.*|CONFIG_SYSROOT=\&quot;&quot;${BASE}&quot;i486-linux-musl-cross\&quot;|&quot; .config
      sed -i &quot;s|.*CONFIG_EXTRA_CFLAGS.*|CONFIG_EXTRA_CFLAGS=-I$BASE/i486-linux-musl-cross/include|&quot; .config
      sed -i &quot;s|.*CONFIG_EXTRA_LDFLAGS.*|CONFIG_EXTRA_LDFLAGS=-L$BASE/i486-linux-musl-cross/lib|&quot; .config
      </code></pre>
      <!--kg-card-end: markdown-->
      <p>Build the BusyBox.</p>
      <pre><code>make ARCH=x86 -j ${CORES}
      make ARCH=x86 install</code></pre>
      <h3 id="check-1">Check</h3>
      <pre><code>$ file filesystem/bin/busybox
      filesystem/bin/busybox: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), statically linked, stripped</code></pre>
      <h2 id="filesystem">Filesystem</h2>
      <p>
        Filesystem needs to be build with <em>xz --check=crc32</em> using this
        command:
      </p>
      <pre><code>find . | cpio -H newc -o | xz --check=crc32 &gt; ../rootfs.cpio.xz</code></pre>
      <p>
        <strong>Remember</strong> to change <em>rootfs.cpio.gz</em> to
        <em>rootfs.cpio<strong>.xz</strong></em> from that point.
      </p>
      <h2 id="booting">Booting</h2>
      <pre><code>qemu-system-i386 -kernel bzImage -initrd rootfs.cpio.xz</code></pre>
      <figure class="kg-card kg-image-card">
        <img src="content/images/latest-build.png" />
      </figure>
      <h2 id="summary">Summary</h2>
      <p>
        Kernel size: 632KiB -&gt;<strong> 594KiB</strong><br />Tools: 552KiB
        -&gt; <strong>121KiB</strong>
      </p>
    </main>
    <footer>
      <hr />
      <pre>

                                   _________________
                                  /_/ FLOPPINUX  /_/;
                                 / ' boot disk  ' //
                                / '------------' //
                               /   .--------.   //
                              /   /         /  //
                             .___/_________/__//   1440KiB
                             '===\_________\=='   3.5&quot;


                         Now go and make something fun with it!



      </pre>
      <nav><a href="/floppinux/">back to home</a></nav>
    </footer>
  </body>
</html>
